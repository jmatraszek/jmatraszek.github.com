<!DOCTYPE html>
<html>
<head>
   <meta charset="utf-8">
   <title>matraszek.dev - Using tcpdump to diagnose OpenVPN connection</title>
   <link rel="stylesheet" type="text/css" href="https://matraszek.dev/css/style.css" >
   <link rel="alternate" type="application/atom+xml" href="https://matraszek.dev/rss.xml" title="RSS">
   <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
   <link rel="me" href="https://mastodon.social/@kubaxvx">
</head>
<body>

<div class="container">
<header class="masthead">
   <h3 class="masthead-title">
     <a href="/">matraszek.dev</a>
     <small>
        &nbsp;&nbsp;&nbsp;<a href="/posts/">Blog</a>
     </small>
     <small>
        &nbsp;&nbsp;&nbsp;<a href="/projects/">Projects</a>
     </small>
     <small>
        &nbsp;&nbsp;&nbsp;<a href="/resume/">Résumé</a>
     </small>
     <small>
       &nbsp;&nbsp;&nbsp;<a href="/rss.xml">Feed</a>
     </small>
   </h3>
</header>

<div id="content">
  <h1>Using tcpdump to diagnose OpenVPN connection</h1>
<p>Recently, I encountered a weird problem in my network setup. I've got router box
running OPNsense. On the router I also run an OpenVPN server so I can access my
LAN from the outside. This works perfectly. I wanted to use OpenVPN to access
my work computer (it's inside corporate network with no chance for port
forwarding). Figured out that the easiest solution would be to have an OpenVPN client
(that connects to the server on my router) always running. And this was
behaving strangely... VPN connection was up and running, I could access home LAN
from my workstation, but I could not access my work machine from within home
LAN.</p>
<p>The desired setup should look like this:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">+-------------+
</span><span style="color:#c0c5ce;">| Router      |
</span><span style="color:#c0c5ce;">|             |                     +-------------+
</span><span style="color:#c0c5ce;">|      +------+                     | Office      |
</span><span style="color:#c0c5ce;">|  +---| VPN  |------Internet-------| workstation |
</span><span style="color:#c0c5ce;">|  |   |server|                     |             |
</span><span style="color:#c0c5ce;">+------+------+                     +-------------+
</span><span style="color:#c0c5ce;">   |
</span><span style="color:#c0c5ce;">   |
</span><span style="color:#c0c5ce;">  LAN
</span><span style="color:#c0c5ce;">   |
</span><span style="color:#c0c5ce;">   |
</span><span style="color:#c0c5ce;">+-------------+
</span><span style="color:#c0c5ce;">| Local       |
</span><span style="color:#c0c5ce;">| workstation |
</span><span style="color:#c0c5ce;">|             |
</span><span style="color:#c0c5ce;">+-------------+
</span></code></pre>
<p>Some details of my configuration:</p>
<ul>
<li>My LAN network is <code>192.168.160.0/21</code>;</li>
<li>OpenVPN network is <code>10.168.164.0/24</code>;</li>
<li>OpenVPN is running in <code>tun</code> mode with topology <code>subnet</code> and <code>client-to-client</code> connections enabled;</li>
<li><code>10.168.164.2</code> is the machine I was trying to reach — this is the office workstation;</li>
<li><code>192.168.161.1</code> is a machine inside LAN from which I was trying to reach the office workstation - this is the local workstation;</li>
<li><code>igb1</code> is LAN's interface on router, <code>ovpns1</code> is VPN's interface on router; <code>tun0</code> is VPN's interface on the office workstation.</li>
</ul>
<p>I used curl to access the office workstation. I expected one packet (<code>SYN</code>, first step of a three-way TCP handshake) to be sent from my home machine, and one packet (<code>RST</code>, since port 80 is closed) to be sent to my home machine from my work machine. I started tinkering with <code>tcpdump</code> to see what is going on... first on the client (I could log into it, because I left an open SSH tunnel):</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">$ sudo tcpdump -i tun0
</span><span style="color:#c0c5ce;">[...]
</span></code></pre>
<p>No packets captured, nothing reached my client. Then I started listening on VPN's interface on router to see if anything reached OpenVPN server so it can send it to the client:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># tcpdump -a -i ovpns1 net 10.168.164.0/24
</span><span style="color:#c0c5ce;">[...]
</span></code></pre>
<p>Nothing. So I sniffed LAN's interface to verify packets reach LAN side on router.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># tcpdump -i igb1 net 10.168.164.0/24
</span><span style="color:#c0c5ce;">[...]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:35:23.740269 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909335576 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:35:24.749749 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909336586 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:35:26.959746 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909338796 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:35:31.013065 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909342849 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:35:39.119756 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909350955 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:35:55.546429 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909367382 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:36:27.973069 IP 192.168.161.1.41506 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">152436380, win 29200, options [mss 1460,sackOK,TS val 1909399807 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span></code></pre>
<p>Not exactly what I expected, but at least I have something. The packet from my machine reached router on LAN's interface, but there was no response. We can see that curl was trying to reconnect (after 1, 2, 4, 8, 16, 32 seconds). So I tried accessing the work machine directly from router's command line (bypassing LAN's interface) while still listening on <code>ovpns1</code>:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># tcpdump -a -i ovpns1 net 10.168.164.2/32
</span><span style="color:#c0c5ce;">[...]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">15:56:23.815123 IP router.home.lan.53122 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">2365664724, win 65228, options [mss 1460,nop,wscale 7,sackOK,TS val 2658382376
</span><span style="color:#c0c5ce;">ecr 0], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">15:56:23.827799 IP 10.168.164.2.http &gt; router.home.lan.53122: Flags [R.], seq
</span><span style="color:#c0c5ce;">0, ack 2365664725, win 0, length 0
</span></code></pre>
<p>Okay, this worked. So it means the problem only appears when the packet enters through LAN. This got me thinking... and suddenly everything clicked! I've got WAN failover configured and a firewall rule that routes every LAN packet to the WAN gateway group! So there is no way I can access OpenVPN's client from LAN, because all traffic goes directly to the gateway. The fix was to add a rule with a higher priority for OpenVPN's network:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># pfctl -sr
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">pass in quick on igb1 inet from any to (openvpn:network) flags S/SA keep state
</span><span style="color:#c0c5ce;">label &quot;USER_RULE: Allow traffic from LAN to OpenVPN.&quot;
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">pass in quick on igb1 route-to (igb0 XX.XX.XX.XX) sticky-address inet all flags
</span><span style="color:#c0c5ce;">S/SA keep state label &quot;USER_RULE: Default allow LAN to any rule&quot;
</span></code></pre>
<p>And everything worked properly.</p>
<p>Test from the home workstation:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">$ curl 10.168.164.2
</span><span style="color:#c0c5ce;">curl: (7) Failed to connect to 10.168.164.2 port 80: Connection refused
</span></code></pre>
<p>Packets enter the router on LAN interface:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># tcpdump -i igb1 net 10.168.164.0/24
</span><span style="color:#c0c5ce;">[...]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:43:53.830956 IP 192.168.161.1.41566 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">457019163, win 29200, options [mss 1460,sackOK,TS val 1909845655 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:43:53.841831 IP 10.168.164.2.http &gt; 192.168.161.1.41566: Flags [R.], seq 0,
</span><span style="color:#c0c5ce;">ack 457019164, win 0, length 0
</span></code></pre>
<p>Go through OpenVPN's interface:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"># tcpdump -a -i ovpns1 net 10.168.164.0/24
</span><span style="color:#c0c5ce;">[...]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:43:53.831042 IP 192.168.161.1.41566 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">457019163, win 29200, options [mss 1460,sackOK,TS val 1909845655 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:43:53.841763 IP 10.168.164.2.http &gt; 192.168.161.1.41566: Flags [R.], seq 0,
</span><span style="color:#c0c5ce;">ack 457019164, win 0, length 0
</span></code></pre>
<p>And reach the office workstation:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">$ sudo tcpdump -i tun0
</span><span style="color:#c0c5ce;">[...]
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:43:53.838111 IP 192.168.161.1.41566 &gt; 10.168.164.2.http: Flags [S], seq
</span><span style="color:#c0c5ce;">457019163, win 29200, options [mss 1357,sackOK,TS val 1909845655 ecr
</span><span style="color:#c0c5ce;">0,nop,wscale 7], length 0
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">21:43:53.838167 IP 10.168.164.2.http &gt; 192.168.161.1.41566: Flags [R.], seq 0,
</span><span style="color:#c0c5ce;">ack 457019164, win 0, length 0
</span></code></pre>
<p>Now it feels like a rookie mistake and something that can be done only by an inexperienced network administrators like me, but I decided to post the solution here — maybe it will spare some time for people who may have a similiar issue.</p>

</div>

</div><!-- .container -->
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT / PD</a>
    -
    Built with <a href="https://github.com/cobalt-org/cobalt.rs">Cobalt</a> using <a href="https://github.com/henrythemes/jekyll-minimal-theme">jekyll-minimal-theme</a>.
  </p>
  <br>
</footer>

</body>
</html>
